<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>School Tracker</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: rgba(17,24,39,.10);
      --shadow: 0 8px 26px rgba(17,24,39,.08);
      --accent: #2AABEE;
      --accentText: #ffffff;
      --danger: #ef4444;
      --success: #16a34a;

      --radius: 16px;
      --gap: 12px;
    }

    /* Telegram theme support */
    body.tg {
      --bg: var(--tg-theme-bg-color, var(--bg));
      --text: var(--tg-theme-text-color, var(--text));
      --muted: color-mix(in srgb, var(--text) 55%, transparent);
      --card: var(--tg-theme-secondary-bg-color, var(--card));
      --accent: var(--tg-theme-button-color, var(--accent));
      --accentText: var(--tg-theme-button-text-color, var(--accentText));
      --border: color-mix(in srgb, var(--text) 12%, transparent);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 14px 14px calc(18px + env(safe-area-inset-bottom));
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 5;
      padding: 10px 0;
      background: linear-gradient(to bottom, var(--bg) 75%, transparent);
      backdrop-filter: blur(6px);
    }

    .title{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius);
      background: color-mix(in srgb, var(--card) 75%, transparent);
      border: 1px solid var(--border);
    }
    .title h1{
      margin: 0;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .pill{
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--card) 90%, transparent);
      white-space: nowrap;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      margin-top: var(--gap);
    }

    .row{
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 420px){
      .row.two{
        grid-template-columns: 1fr 1fr;
      }
    }

    .label{
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px 2px;
    }

    input{
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      color: var(--text);
      outline: none;
      font-size: 15px;
    }
    input:focus{
      border-color: color-mix(in srgb, var(--accent) 45%, var(--border));
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 18%, transparent);
    }

    .btn{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px 12px;
      border: 0;
      border-radius: 14px;
      background: var(--accent);
      color: var(--accentText);
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      user-select: none;
      transition: transform .04s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn.secondary{
      background: color-mix(in srgb, var(--card) 85%, transparent);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .muted{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .subjects{
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .subject{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: color-mix(in srgb, var(--card) 92%, transparent);
    }
    .subjectTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .subjectName{
      margin: 0;
      font-weight: 800;
      font-size: 15px;
    }
    .badge{
      font-size: 12px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 90%, transparent);
      white-space: nowrap;
    }

    .bar{
      height: 10px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--text) 8%, transparent);
      overflow: hidden;
      margin-top: 10px;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: var(--accent);
      border-radius: 999px;
    }

    .meta{
      margin-top: 10px;
      display: grid;
      gap: 4px;
      font-size: 13px;
    }

    .ok{ color: var(--success); font-weight: 800; }
    .warn{ color: #f59e0b; font-weight: 800; }
    .bad{ color: var(--danger); font-weight: 800; }

    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      font-size: 13px;
    }

    .footerSpace{ height: 6px; }
  </style>
</head>

<body class="tg">
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>üìö School Tracker</h1>
        <div id="userPill" class="pill">‚Ä¶</div>
      </div>
    </div>

    <div class="card">
      <button class="btn secondary" onclick="loadStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
      <div id="statsHint" class="muted" style="margin-top:10px;">
        –ù–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É¬ª –∏–ª–∏ –¥–æ–±–∞–≤—å –ø—Ä–µ–¥–º–µ—Ç –Ω–∏–∂–µ.
      </div>
      <div id="subjects" class="subjects"></div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div>
          <div style="font-weight:900;">‚ûï –î–æ–±–∞–≤–∏—Ç—å / –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</div>
          <div class="muted">–°–µ—Ä–≤–µ—Ä —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç —Ç–≤–æ–π ID —á–µ—Ä–µ–∑ Telegram initData.</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="label">–ü—Ä–µ–¥–º–µ—Ç</div>
        <input id="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" autocomplete="off" />
      </div>

      <div class="row two" style="margin-top:10px;">
        <div>
          <div class="label">–ü—Ä–æ–ø—É—Å–∫–∏</div>
          <input id="missed" placeholder="0" type="number" min="0" inputmode="numeric" />
        </div>
        <div>
          <div class="label">–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π</div>
          <input id="total" placeholder="1" type="number" min="1" inputmode="numeric" />
        </div>
      </div>

      <button class="btn" style="margin-top:12px;" onclick="addSubject()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

      <div id="result" class="toast muted" style="display:none;"></div>
    </div>

    <div class="footerSpace"></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
    // tg.MainButton.hide();

    const BACKEND_URL = "https://school-tracker-api-hxjl.onrender.com";

    const user = tg.initDataUnsafe?.user;
    const userPill = document.getElementById("userPill");
    userPill.textContent = user
      ? `${user.first_name || "User"} ¬∑ ID ${user.id}`
      : "–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞";

    function showResult(text) {
      const el = document.getElementById("result");
      el.style.display = "block";
      el.innerHTML = text;
    }

    function requireInitData() {
      const initData = tg.initData;
      if (!initData) {
        alert("tg.initData –ø—É—Å—Ç–æ–π ‚Äî –æ—Ç–∫—Ä–æ–π Mini App —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞ (/start ‚Üí üìä –û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–µ–∫–µ—Ä).");
        return null;
      }
      return initData;
    }

    function statusByPercent(p) {
      if (p < 40) return {label: "‚úÖ –û–∫", cls: "ok"};
      if (p <= 60) return {label: "‚ö†Ô∏è –†–∏—Å–∫", cls: "warn"};
      return {label: "‚ùå –ü–µ—Ä–µ–±–æ—Ä", cls: "bad"};
    }

    function renderSubjects(subjects) {
      const box = document.getElementById("subjects");
      const hint = document.getElementById("statsHint");

      if (!subjects || !subjects.length) {
        box.innerHTML = "";
        hint.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç –Ω–∏–∂–µ üëá";
        return;
      }

      hint.textContent = `–ü—Ä–µ–¥–º–µ—Ç–æ–≤: ${subjects.length}`;

      box.innerHTML = subjects.map(s => {
        const missed = Number(s.missed || 0);
        const total  = Number(s.total || 0);
        const percent = total ? (missed / total * 100) : 0;
        const percentText = total ? percent.toFixed(1) : "0.0";
        const maxMissed = Math.floor(total * 0.6);
        const canMiss = Math.max(0, maxMissed - missed);

        const st = statusByPercent(percent);
        const width = Math.min(100, Math.max(0, percent));

        return `
          <div class="subject">
            <div class="subjectTop">
              <div>
                <div class="subjectName">üìò ${escapeHtml(s.name || "‚Äî")}</div>
                <div class="muted">–ü—Ä–æ–ø—É—Å–∫–∏: ${missed}/${total}</div>
              </div>
              <div class="badge ${st.cls}">${st.label}</div>
            </div>

            <div class="bar" aria-label="Progress">
              <div style="width:${width}%;"></div>
            </div>

            <div class="meta">
              <div>–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ–ø—É—Å–∫–æ–≤: <b>${percentText}%</b></div>
              <div>–ú–æ–∂–Ω–æ –µ—â—ë –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å (60%): <b>${canMiss}</b></div>
            </div>
          </div>
        `;
      }).join("");
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function loadStats() {
      const initData = requireInitData();
      if (!initData) return;

      const r = await fetch(`${BACKEND_URL}/tg/stats`, {
        headers: { "X-Telegram-Init-Data": initData }
      });

      if (!r.ok) {
        const err = await r.text();
        alert(`–û—à–∏–±–∫–∞ /tg/stats: HTTP ${r.status}\n${err}`);
        return;
      }

      const data = await r.json();
      renderSubjects(data.subjects || []);
    }

    async function addSubject() {
      const initData = requireInitData();
      if (!initData) return;

      const name = document.getElementById("name").value.trim();
      const missed = Number(document.getElementById("missed").value);
      const total = Number(document.getElementById("total").value);

      if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç");
      if (!Number.isFinite(missed) || missed < 0) return alert("–ü—Ä–æ–ø—É—Å–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å >= 0");
      if (!Number.isFinite(total) || total <= 0) return alert("–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0");

      const r = await fetch(`${BACKEND_URL}/tg/add`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Telegram-Init-Data": initData
        },
        body: JSON.stringify({ name, missed, total })
      });

      if (!r.ok) {
        const err = await r.text();
        alert(`–û—à–∏–±–∫–∞ /tg/add: HTTP ${r.status}\n${err}`);
        return;
      }

      const data = await r.json();
      const percentText = (typeof data.percent === "number") ? `${data.percent}%` : "‚Äî";
      const canText = (typeof data.can_miss_more === "number") ? `${data.can_miss_more}` : "‚Äî";

      showResult(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ü—Ä–æ—Ü–µ–Ω—Ç: <b>${percentText}</b> ¬∑ –µ—â—ë –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å: <b>${canText}</b>`);

      // –æ—á–∏—Å—Ç–∏–º –ø–æ–ª—è —á—É—Ç—å –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–µ
      // document.getElementById("name").value = "";
      // document.getElementById("missed").value = "";
      // document.getElementById("total").value = "";

      await loadStats();
    }

    // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ (–º–æ–∂–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ)
    loadStats();
  </script>
</body>
</html>